services:
  # Service 1: The Model Server (Ollama)
  ollama-service:
    image: ollama/ollama:latest
    container_name: sql_model_server
    ports:
      - "11435:11434"
    volumes:
      - ollama_data:/root/.ollama # Persist models so you don't re-download them
      - .:/app # Share project directory for GGUF files
    working_dir: /app
    networks:
      - sql_network
    # Uncomment the deploy section below if you have an NVIDIA GPU & Toolkit installed
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu]

  # # Service 2: The Client/Lab Environment
  lab-runner:
    image: python:3.10-slim
    container_name: sql_lab_runner
    volumes:
      - .:/app
    working_dir: /app
    command: sh -c "apt-get update && apt-get install -y git && pip install -r requirements.txt && git config --global init.defaultBranch main && git config --global user.email \"carlosj12336@gmail.com\" && git config --global user.name \"jcarloshg\" && tail -f /dev/null"
    environment:
      - OLLAMA_HOST=http://ollama-service:11434
      - DB_URI=postgresql://testuser:testpass@postgres-db:5432/company_db
    networks:
      - sql_network
    depends_on:
      - ollama-service
      - postgres-db

  # Service 3: MLflow Tracking Server
  mlflow-server:
    image: ghcr.io/mlflow/mlflow:latest
    container_name: sql_mlflow
    ports:
      - "5000:5000"
    command: mlflow server --host 0.0.0.0 --port 5000
    volumes:
      - ./mlruns:/mlruns # Persist experiment data
    networks:
      - sql_network

  # Service 4: Unsloth GPU Trainer
  unsloth-trainer:
    image: unsloth/unsloth:latest
    container_name: sql_unsloth_trainer
    volumes:
      - .:/workspace/work
    working_dir: /workspace/work
    # GPU Pass-through (Requires nvidia-container-toolkit on host)
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    environment:
      - MLFLOW_TRACKING_URI=http://mlflow-server:5000
    command: tail -f /dev/null
    networks:
      - sql_network

  # Service 5: The Evaluation Database
  postgres-db:
    image: postgres:15-alpine
    container_name: sql_eval_db
    environment:
      - POSTGRES_USER=testuser
      - POSTGRES_PASSWORD=testpass
      - POSTGRES_DB=company_db
    ports:
      - "5433:5432"
    networks:
      - sql_network

volumes:
  ollama_data:

networks:
  sql_network:
    driver: bridge
